{% extends "base.html" %}

{% block title %}Study Topic {{ topic.number }} - Azure AI-900 Study App{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Topic Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="card-title mb-2">{{ topic.title }}</h1>
                            <p class="card-text mb-0">
                                Interactive learning with bite-sized content chunks
                            </p>
                        </div>
                        <div class="text-end">
                            <a href="{{ url_for('index') }}" class="btn btn-light">
                                <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3">
            <div class="sidebar p-3">
                <h5 class="mb-3">
                    <i class="bi bi-list-ul me-2"></i>
                    Topic Sections
                </h5>
                <nav class="nav flex-column">
                    {% for section in topic.sections %}
                    <a class="nav-link" href="#section-{{ loop.index0 }}" 
                       onclick="showSection({{ loop.index0 }})">
                        <i class="bi bi-chevron-right me-1"></i>
                        {{ section.title }}
                    </a>
                    {% endfor %}
                </nav>
                
                <hr>
                
                <!-- Progress for this topic -->
                <div class="mb-3">
                    <h6>Topic Progress</h6>
                    <div class="progress">
                        <div class="progress-bar" id="topic-progress-bar" 
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted" id="progress-text">0% complete</small>
                </div>
                
                <!-- Quick Actions -->
                <div class="d-grid gap-2">
                    <a href="{{ url_for('quiz', quiz_type='topic_' + topic.number|string) }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-question-circle me-1"></i>
                        Topic Quiz
                    </a>
                    <a href="{{ url_for('review') }}" class="btn btn-info btn-sm">
                        <i class="bi bi-bookmark me-1"></i>
                        Quick Review
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9">
            <div id="study-content">
                {% for section in topic.sections %}
                <div class="section-content" id="section-{{ loop.index0 }}" 
                     style="{% if loop.index0 != current_section %}display: none;{% endif %}">
                    
                    <!-- Section Header -->
                    <div class="card mb-4">
                        <div class="card-body bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="card-title text-primary mb-0">
                                    <i class="bi bi-bookmark-fill me-2"></i>
                                    {{ section.title }}
                                </h3>
                                <button class="btn btn-outline-primary btn-sm bookmark-btn" 
                                        data-bookmark-id="topic_{{ topic.number }}_section_{{ loop.index0 }}"
                                        onclick="toggleBookmark(this)">
                                    <i class="bi bi-star"></i>
                                    <span class="bookmark-text">Bookmark</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Chunks -->
                    {% set section_index = loop.index0 %}
                    {% for chunk in section.chunks %}
                    <div class="chunk-content" id="chunk-{{ section_index }}-{{ loop.index0 }}"
                         style="{% if loop.index0 != current_chunk and section_index == current_section %}display: none;{% elif section_index != current_section %}display: none;{% endif %}">
                        
                        <div class="study-chunk">
                            {{ chunk.content | markdown | safe }}
                        </div>
                        
                        <!-- Study Notes Section -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-pencil-square me-2"></i>
                                    Your Notes
                                </h6>
                                <textarea class="form-control study-note" 
                                          rows="3" 
                                          placeholder="Add your personal notes here..."
                                          data-note-id="topic_{{ topic.number }}_section_{{ section_index }}_chunk_{{ loop.index0 }}"
                                          onchange="saveNote(this)"></textarea>
                                <small class="text-muted">Notes are saved automatically</small>
                            </div>
                        </div>
                        
                        <!-- Chunk Navigation -->
                        <div class="study-navigation">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% if not (section_index == 0 and loop.index0 == 0) %}
                                    <button class="btn btn-outline-primary" 
                                            onclick="previousChunk({{ section_index }}, {{ loop.index0 }})">
                                        <i class="bi bi-chevron-left me-1"></i>Previous
                                    </button>
                                    {% endif %}
                                </div>
                                
                                <div class="text-center">
                                    <small class="text-muted">
                                        Section {{ section_index + 1 }} of {{ topic.sections|length }} â€¢ 
                                        Chunk {{ loop.index }} of {{ section.chunks|length }}
                                    </small>
                                </div>
                                
                                <div>
                                    {% if not (section_index == (topic.sections|length - 1) and loop.index0 == (section.chunks|length - 1)) %}
                                    <button class="btn btn-primary" 
                                            onclick="nextChunk({{ section_index }}, {{ loop.index0 }})">
                                        Next<i class="bi bi-chevron-right ms-1"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-success" onclick="completeTopicStudy()">
                                        <i class="bi bi-check-circle-fill me-1"></i>Complete Topic
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                
                <!-- Topic Completion Message -->
                <div id="completion-message" style="display: none;">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="bi bi-trophy-fill display-4 mb-3"></i>
                            <h3>Congratulations!</h3>
                            <p class="mb-3">You've completed Topic {{ topic.number }}!</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{{ url_for('quiz', quiz_type='topic_' + topic.number|string) }}" 
                                   class="btn btn-light">
                                    <i class="bi bi-question-circle me-1"></i>Take Topic Quiz
                                </a>
                                <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                                    <i class="bi bi-house me-1"></i>Back to Dashboard
                                </a>
                                {% if topic.number < 5 %}
                                <a href="{{ url_for('study_topic', topic_num=topic.number + 1) }}" 
                                   class="btn btn-warning">
                                    <i class="bi bi-arrow-right me-1"></i>Next Topic
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSection = {{ current_section }};
    let currentChunk = {{ current_chunk }};
    let totalSections = {{ topic.sections|length }};
    let sectionsData = {{ topic.sections|tojson }};
    
    function updateStudyProgress() {
        let totalChunks = 0;
        let completedChunks = 0;
        
        sectionsData.forEach((section, sectionIndex) => {
            totalChunks += section.chunks.length;
            if (sectionIndex < currentSection) {
                completedChunks += section.chunks.length;
            } else if (sectionIndex === currentSection) {
                completedChunks += currentChunk;
            }
        });
        
        const progressPercentage = totalChunks > 0 ? (completedChunks / totalChunks) * 100 : 0;
        
        document.getElementById('topic-progress-bar').style.width = progressPercentage + '%';
        document.getElementById('topic-progress-bar').setAttribute('aria-valuenow', progressPercentage);
        document.getElementById('progress-text').textContent = Math.round(progressPercentage) + '% complete';
        
        // Save progress using the common function from base.html
        saveProgress({
            topic: {{ topic.number }},
            section: currentSection,
            chunk: currentChunk,
            last_study_date: new Date().toISOString()
        });
    }
    
    function showSection(sectionIndex) {
        // Hide all sections
        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById('section-' + sectionIndex).style.display = 'block';
        
        currentSection = sectionIndex;
        currentChunk = 0;
        showChunk(sectionIndex, 0);
        updateStudyProgress();
    }
    
    function showChunk(sectionIndex, chunkIndex) {
        // Hide all chunks in this section
        document.querySelectorAll(`#section-${sectionIndex} .chunk-content`).forEach(chunk => {
            chunk.style.display = 'none';
        });
        
        // Show selected chunk
        const chunkElement = document.getElementById(`chunk-${sectionIndex}-${chunkIndex}`);
        if (chunkElement) {
            chunkElement.style.display = 'block';
            // Don't auto-scroll - keeps topic header visible
        }
    }
    
    function nextChunk(sectionIndex, chunkIndex) {
        const section = sectionsData[sectionIndex];
        
        if (chunkIndex + 1 < section.chunks.length) {
            // Next chunk in same section
            currentChunk = chunkIndex + 1;
            showChunk(sectionIndex, currentChunk);
        } else if (sectionIndex + 1 < totalSections) {
            // First chunk of next section
            currentSection = sectionIndex + 1;
            currentChunk = 0;
            showSection(currentSection);
        } else {
            // At the end of the topic - show completion
            completeTopicStudy();
            return; // Don't update progress again
        }
        
        updateStudyProgress();
    }
    
    function previousChunk(sectionIndex, chunkIndex) {
        if (chunkIndex > 0) {
            // Previous chunk in same section
            currentChunk = chunkIndex - 1;
            showChunk(sectionIndex, currentChunk);
        } else if (sectionIndex > 0) {
            // Last chunk of previous section
            currentSection = sectionIndex - 1;
            const prevSection = sectionsData[currentSection];
            currentChunk = prevSection.chunks.length - 1;
            showSection(currentSection);
        }
        // If already at first chunk of first section, do nothing (don't go blank)
        
        updateStudyProgress();
    }
    
    function completeTopicStudy() {
        // Mark topic as completed
        fetch('/api/update_progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                completed_topic: {{ topic.number }}
            })
        }).then(() => {
            // Show completion message
            document.getElementById('study-content').style.display = 'none';
            document.getElementById('completion-message').style.display = 'block';
            document.getElementById('completion-message').scrollIntoView({ behavior: 'smooth' });
        });
    }
    
    // Keyboard navigation - only when NOT typing in input/textarea
    document.addEventListener('keydown', function(e) {
        // Don't trigger shortcuts if user is typing in an input or textarea
        const activeElement = document.activeElement;
        if (activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'TEXTAREA' || 
            activeElement.isContentEditable) {
            return; // Let the user type normally
        }
        
        // Don't navigate if completion message is showing
        const completionMsg = document.getElementById('completion-message');
        if (completionMsg && completionMsg.style.display !== 'none') {
            return; // Topic is complete, don't navigate
        }
        
        if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault();
            // Find the currently visible chunk's navigation buttons
            const currentChunkId = `chunk-${currentSection}-${currentChunk}`;
            const currentChunkElement = document.getElementById(currentChunkId);
            if (currentChunkElement && currentChunkElement.style.display !== 'none') {
                const nextBtn = currentChunkElement.querySelector('.study-navigation .btn-primary, .study-navigation .btn-success');
                if (nextBtn) {
                    nextBtn.click();
                }
            }
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            // Find the currently visible chunk's navigation buttons
            const currentChunkId = `chunk-${currentSection}-${currentChunk}`;
            const currentChunkElement = document.getElementById(currentChunkId);
            if (currentChunkElement && currentChunkElement.style.display !== 'none') {
                const prevBtn = currentChunkElement.querySelector('.study-navigation .btn-outline-primary');
                if (prevBtn) {
                    prevBtn.click();
                }
            }
        }
    });
    
    // Initialize progress
    updateStudyProgress();
    
    // Load notes and bookmarks
    loadNotesAndBookmarks();
    
    function saveNote(textarea) {
        const noteId = textarea.getAttribute('data-note-id');
        const noteText = textarea.value;
        
        fetch('/api/save_note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                note_id: noteId,
                note_text: noteText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show brief success indicator
                textarea.classList.add('border-success');
                setTimeout(() => textarea.classList.remove('border-success'), 1000);
            }
        })
        .catch(error => {
            console.error('Error saving note:', error);
            showNotification('Error saving note', 'danger');
        });
    }
    
    function toggleBookmark(button) {
        const bookmarkId = button.getAttribute('data-bookmark-id');
        
        fetch('/api/toggle_bookmark', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                bookmark_id: bookmarkId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const icon = button.querySelector('i');
                const text = button.querySelector('.bookmark-text');
                
                if (data.bookmarked) {
                    icon.className = 'bi bi-star-fill';
                    text.textContent = 'Bookmarked';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-warning');
                    showNotification('Section bookmarked', 'success');
                } else {
                    icon.className = 'bi bi-star';
                    text.textContent = 'Bookmark';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-outline-primary');
                    showNotification('Bookmark removed', 'info');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling bookmark:', error);
            showNotification('Error updating bookmark', 'danger');
        });
    }
    
    function loadNotesAndBookmarks() {
        // Load all notes
        fetch('/api/get_notes')
            .then(response => response.json())
            .then(data => {
                const notes = data.notes || {};
                
                // Populate note textareas
                document.querySelectorAll('.study-note').forEach(textarea => {
                    const noteId = textarea.getAttribute('data-note-id');
                    if (notes[noteId]) {
                        textarea.value = notes[noteId].text;
                    }
                });
            })
            .catch(error => console.error('Error loading notes:', error));
        
        // Load bookmarks from localStorage (saved by saveProgress)
        const savedProgress = JSON.parse(localStorage.getItem('ai900_progress') || '{}');
        const bookmarks = savedProgress.bookmarks || [];
        
        document.querySelectorAll('.bookmark-btn').forEach(button => {
            const bookmarkId = button.getAttribute('data-bookmark-id');
            if (bookmarks.includes(bookmarkId)) {
                const icon = button.querySelector('i');
                const text = button.querySelector('.bookmark-text');
                icon.className = 'bi bi-star-fill';
                text.textContent = 'Bookmarked';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-warning');
            }
        });
    }
</script>
{% endblock %} 